<!DOCTYPE html>
<html>
<head>
    <title>Store Coverage Table v0.3</title>
    <meta charset="utf-8" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        /* Search and Export Controls */
        .controls-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
        .btn-export {
            padding: 12px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-export:hover { background-color: #218838; }

        .btn-export-secondary {
            padding: 12px 20px;
            background-color: #007bff; /* Blue */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-export-secondary:hover { background-color: #0069d9; }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
        }
        th {
            background-color: #333;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Specific Column Formatting */
        .col-store { width: 20%; font-weight: bold; }
        .col-bb    { width: 40%; }
        .col-radio { width: 40%; }

        .list-item {
            margin-bottom: 4px;
            font-size: 14px;
        }
        .empty-msg {
            color: #999;
            font-style: italic;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry"></script>
</head>
<body>

<div class="container">
    <h1>Store Coverage Report</h1>
    
    <div class="controls-container">
        <input type="text" id="searchInput" placeholder="Search by Store Name or Number..." onkeyup="filterTable()">
        <button class="btn-export" onclick="downloadCSV()">Export Detailed CSV</button>
        <button class="btn-export-secondary" onclick="downloadCondensedCSV()">Export Condensed CSV (One Item Per Row)</button>
    </div>

    <table id="coverageTable">
        <thead>
            <tr>
                <th class="col-store">Store Information</th>
                <th class="col-bb">Billboard Coverage (In Range)</th>
                <th class="col-radio">Radio Coverage (In Range)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="3" class="loading">Loading data...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // Data Containers
    let allStores = [];
    let allBillboards = [];
    let allStations = [];
    let currentDisplayedStores = []; 

    // URLs for your data files
    const urls = {
        store: './locations.json',
        billboard: './billboards.json',
        radio: './radio.json'
    };

    function init() {
        Promise.all([
            fetch(urls.store).then(r => r.json()),
            fetch(urls.billboard).then(r => r.json()),
            fetch(urls.radio).then(r => r.json())
        ]).then(([stores, billboards, radios]) => {
            
            allStores = stores;
            
            // Normalize
            allBillboards = billboards.map(b => ({...b, Type: 'Billboard'}));
            allStations = radios.map(r => ({...r, Type: 'Station'}));

            calculateCoverage();

            currentDisplayedStores = allStores;
            renderTable(currentDisplayedStores);

        }).catch(err => {
            console.error(err);
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">Error loading data files. Ensure JSON files are in the same directory.</td></tr>`;
        });
    }

    function calculateCoverage() {
        allStores.forEach(store => {
            const storeLoc = new google.maps.LatLng(store.Latitude, store.Longitude);

            // 1. Find Billboards in range
            store.nearbyBillboards = allBillboards.filter(bb => {
                const bbLoc = new google.maps.LatLng(bb.Latitude, bb.Longitude);
                const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(storeLoc, bbLoc);
                const radiusMeters = (bb.Radius || 0) * 1609.34; 
                return distanceMeters <= radiusMeters;
            });

            // 2. Find Radio Stations in range
            store.nearbyStations = allStations.filter(station => {
                const stationLoc = new google.maps.LatLng(station.Latitude, station.Longitude);
                const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(storeLoc, stationLoc);
                const radiusMeters = (station.Radius || 0) * 1609.34;
                return distanceMeters <= radiusMeters;
            });
        });
    }

    function renderTable(storesToRender) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (storesToRender.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="loading">No stores found matching your search.</td></tr>';
            return;
        }

        storesToRender.forEach(store => {
            const tr = document.createElement('tr');

            // Store Column
            const storeCell = document.createElement('td');
            storeCell.className = 'col-store';
            storeCell.textContent = store.Name;
            tr.appendChild(storeCell);

            // Billboard Column
            const bbCell = document.createElement('td');
            bbCell.className = 'col-bb';
            if (store.nearbyBillboards.length > 0) {
                store.nearbyBillboards.forEach(bb => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<strong>ON #${bb.Name}</strong>: ${bb.Info || 'N/A'}`; 
                    bbCell.appendChild(div);
                });
            } else {
                bbCell.innerHTML = '<span class="empty-msg">No billboards in range</span>';
            }
            tr.appendChild(bbCell);

            // Radio Column
            const radioCell = document.createElement('td');
            radioCell.className = 'col-radio';
            if (store.nearbyStations.length > 0) {
                store.nearbyStations.forEach(st => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<strong>${st.Name}</strong> (${st.Genre || 'N/A'}) - Rank: ${st.Rank || 'N/A'}`;
                    radioCell.appendChild(div);
                });
            } else {
                radioCell.innerHTML = '<span class="empty-msg">No stations in range</span>';
            }
            tr.appendChild(radioCell);

            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase().trim();

        currentDisplayedStores = allStores.filter(store => {
            const storeName = store.Name.toLowerCase();
            return storeName.includes(filter);
        });

        renderTable(currentDisplayedStores);
    }

    // --- CSV UTILITIES ---

    function escapeCsv(text) {
        if (text === null || text === undefined) return '""';
        return '"' + String(text).replace(/"/g, '""') + '"';
    }

    function triggerDownload(content, filename) {
        const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- BUTTON 1: DETAILED CSV ---
    function downloadCSV() {
        if (!currentDisplayedStores || currentDisplayedStores.length === 0) {
            alert("No data to export!");
            return;
        }

        const headers = ["Store Name", "Store Latitude", "Store Longitude", "Matched Billboards", "Matched Stations"];
        
        const rows = currentDisplayedStores.map(store => {
            const billboardsStr = store.nearbyBillboards.map(bb => `ON #${bb.Name} (${bb.Info || ''})`).join("; ");
            const stationsStr = store.nearbyStations.map(st => `${st.Name} (${st.Genre || ''})`).join("; ");

            return [
                escapeCsv(store.Name),
                escapeCsv(store.Latitude),
                escapeCsv(store.Longitude),
                escapeCsv(billboardsStr),
                escapeCsv(stationsStr)
            ].join(",");
        });

        const csvContent = [headers.join(","), ...rows].join("\n");
        triggerDownload(csvContent, "coverage_detailed.csv");
    }

    // --- BUTTON 2: CONDENSED CSV (ONE ROW PER ITEM) ---
    function downloadCondensedCSV() {
        if (!currentDisplayedStores || currentDisplayedStores.length === 0) {
            alert("No data to export!");
            return;
        }

        // Headers: Store, Billboard Full Info, Radio Call Sign
        const headers = ["Store Number/Name", "Billboard Coverage", "Station Call Sign"];
        
        let csvRows = [];

        // Add Header Row
        csvRows.push(headers.join(","));

        currentDisplayedStores.forEach(store => {
            const storeName = escapeCsv(store.Name);
            let hasData = false;

            // 1. Generate one row for every Billboard
            store.nearbyBillboards.forEach(bb => {
                hasData = true;
                
                // Remove "ON #" (case insensitive) from the Name and combine with Info
                const cleanName = String(bb.Name).replace(/ON\s?#/gi, '').trim();
                const fullBillboardValue = `${cleanName}: ${bb.Info || 'N/A'}`;

                // Row Format: Store, Full Billboard Value, (Empty Radio)
                csvRows.push([storeName, escapeCsv(fullBillboardValue), '""'].join(","));
            });

            // 2. Generate one row for every Radio Station
            store.nearbyStations.forEach(st => {
                hasData = true;
                // Row Format: Store, (Empty BB), Radio_Name
                csvRows.push([storeName, '""', escapeCsv(st.Name)].join(","));
            });

            // 3. Optional: If store has NO coverage, output one line so it isn't lost
            if (!hasData) {
                csvRows.push([storeName, '""', '""'].join(","));
            }
        });

        const csvContent = csvRows.join("\n");
        triggerDownload(csvContent, "coverage_condensed.csv");
    }

    window.onload = init;

</script>

</body>
</html>
