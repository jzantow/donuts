<!DOCTYPE html>
<html>
<head>
    <title>Store Coverage Table</title>
    <meta charset="utf-8" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        /* Search Bar Styles */
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
        }
        th {
            background-color: #333;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Specific Column Formatting */
        .col-store { width: 20%; font-weight: bold; }
        .col-bb    { width: 40%; }
        .col-radio { width: 40%; }

        .list-item {
            margin-bottom: 4px;
            font-size: 14px;
        }
        .empty-msg {
            color: #999;
            font-style: italic;
        }
        .highlight {
            background-color: yellow;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlgV94Xs1mTP01IZo3wqQWpx9png3l4DE&libraries=geometry"></script>
</head>
<body>

<div class="container">
    <h1>Store Coverage Report</h1>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search by Store Name or Number..." onkeyup="filterTable()">
    </div>

    <table id="coverageTable">
        <thead>
            <tr>
                <th class="col-store">Store Information</th>
                <th class="col-bb">Billboard Coverage (In Range)</th>
                <th class="col-radio">Radio Coverage (In Range)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="3" class="loading">Loading data...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // Data Containers
    let allStores = [];
    let allBillboards = [];
    let allStations = [];

    // URLs for your data files
    const urls = {
        store: './locations.json',
        billboard: './billboards.json',
        radio: './radio.json'
    };

    function init() {
        Promise.all([
            fetch(urls.store).then(r => r.json()),
            fetch(urls.billboard).then(r => r.json()),
            fetch(urls.radio).then(r => r.json())
        ]).then(([stores, billboards, radios]) => {
            
            // Normalize Data
            allStores = stores; // Assuming locations.json contains stores
            
            // Filter just in case the files are mixed, though we treat them strictly here
            allBillboards = billboards.map(b => ({...b, Type: 'Billboard'}));
            allStations = radios.map(r => ({...r, Type: 'Station'}));

            // Calculate Coverage for every store immediately
            calculateCoverage();

            // Render the full table
            renderTable(allStores);

        }).catch(err => {
            console.error(err);
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">Error loading data files. Ensure JSON files are in the same directory.</td></tr>`;
        });
    }

    function calculateCoverage() {
        allStores.forEach(store => {
            const storeLoc = new google.maps.LatLng(store.Latitude, store.Longitude);

            // 1. Find Billboards in range
            store.nearbyBillboards = allBillboards.filter(bb => {
                const bbLoc = new google.maps.LatLng(bb.Latitude, bb.Longitude);
                const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(storeLoc, bbLoc);
                const radiusMeters = (bb.Radius || 0) * 1609.34; // Convert miles to meters
                return distanceMeters <= radiusMeters;
            });

            // 2. Find Radio Stations in range
            store.nearbyStations = allStations.filter(station => {
                const stationLoc = new google.maps.LatLng(station.Latitude, station.Longitude);
                const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(storeLoc, stationLoc);
                const radiusMeters = (station.Radius || 0) * 1609.34; // Convert miles to meters
                return distanceMeters <= radiusMeters;
            });
        });
    }

    function renderTable(storesToRender) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (storesToRender.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="loading">No stores found matching your search.</td></tr>';
            return;
        }

        storesToRender.forEach(store => {
            const tr = document.createElement('tr');

            // --- Column 1: Store Info ---
            const storeCell = document.createElement('td');
            storeCell.className = 'col-store';
            storeCell.textContent = store.Name;
            tr.appendChild(storeCell);

            // --- Column 2: Billboards ---
            const bbCell = document.createElement('td');
            bbCell.className = 'col-bb';
            if (store.nearbyBillboards.length > 0) {
                store.nearbyBillboards.forEach(bb => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    // Displaying Name (ON #) and Location info
                    div.innerHTML = `<strong>ON #${bb.Name}</strong>: ${bb.Info || 'N/A'}`; 
                    bbCell.appendChild(div);
                });
            } else {
                bbCell.innerHTML = '<span class="empty-msg">No billboards in range</span>';
            }
            tr.appendChild(bbCell);

            // --- Column 3: Radio Stations ---
            const radioCell = document.createElement('td');
            radioCell.className = 'col-radio';
            if (store.nearbyStations.length > 0) {
                store.nearbyStations.forEach(st => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    // Displaying Name, Genre, and Rank
                    div.innerHTML = `<strong>${st.Name}</strong> (${st.Genre || 'N/A'}) - Rank: ${st.Rank || 'N/A'}`;
                    radioCell.appendChild(div);
                });
            } else {
                radioCell.innerHTML = '<span class="empty-msg">No stations in range</span>';
            }
            tr.appendChild(radioCell);

            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase().trim();

        const filteredStores = allStores.filter(store => {
            const storeName = store.Name.toLowerCase();
            // Check if name includes text OR if it includes the number specifically
            return storeName.includes(filter);
        });

        renderTable(filteredStores);
    }

    // Initialize when window loads
    window.onload = init;

</script>

</body>
</html>
